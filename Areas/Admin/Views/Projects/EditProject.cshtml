@model MohammedPortfolio.Models.ViewModels.ProjectCreateViewModel

@{
    ViewData["Title"] = "Edit Project";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container mt-5">
    <h2 class="mb-4 text-center">Edit Project</h2>

    <form  
    asp-area="Admin"
      asp-controller="Projects"
      asp-action="EditProject"
      asp-route-id="@Model.Id"
      method="post"
      enctype="multipart/form-data"
    
    >
        <input type="hidden" asp-for="Id" value="@ViewBag.ProjectId" />

        <!-- Title -->
        <div class="mb-3">
            <label asp-for="Title" class="form-label"></label>
            <input asp-for="Title" class="form-control" />
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>

        <!-- Description -->
        <div class="mb-3">
            <label asp-for="Description" class="form-label"></label>
            <textarea asp-for="Description" class="form-control"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>

        <!-- Overview -->
        <div class="mb-3">
            <label asp-for="Overview" class="form-label">Project Overview</label>
            <textarea asp-for="Overview" class="form-control" rows="3"></textarea>
        </div>

        <!-- Category -->
        <div class="mb-3">
            <label asp-for="CategoryId" class="form-label"></label>
            <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.Categories">
                <option value="">-- Select Category --</option>
            </select>
            <span asp-validation-for="CategoryId" class="text-danger"></span>
        </div>

        <!-- Current Main Image -->
        @if (ViewBag.MainImage != null)
        {
            <div class="mb-3">
                <label class="form-label">Current Main Image</label>
                <div>
                    <img src="data:image/png;base64,@Convert.ToBase64String(ViewBag.MainImage)" width="200" class="rounded shadow" />
                </div>
            </div>
        }

        <!-- Upload New Main Image -->
        <div class="mb-3">
            <label class="form-label">Change Main Image (optional)</label>
            <input type="file" asp-for="ImageFile" class="form-control" accept="image/*" />
        </div>

        <!-- Tools -->
        <div class="mb-3">
            <label class="form-label">Project Tools</label>
            <div id="tools-container">
                @if (Model.Tools != null && Model.Tools.Any())
                {
                    int toolIndex = 0;
                    foreach (var tool in Model.Tools)
                    {
                        <div class="input-group mb-2">
                            <input type="text" name="Tools[@toolIndex]" value="@tool" class="form-control" />
                            <button type="button" class="btn btn-danger" onclick="removeTool(this)">X</button>
                        </div>
                        toolIndex++;
                    }
                }
                else
                {
                    <div class="input-group mb-2">
                        <input type="text" name="Tools[0]" class="form-control" placeholder="Enter a tool name" />
                        <button type="button" class="btn btn-danger" onclick="removeTool(this)">X</button>
                    </div>
                }
            </div>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="addTool()">+ Add Another Tool</button>
        </div>

        <!-- Additional Images -->
      <div class="mb-3">
            <label class="form-label">Additional Images</label>

            <!-- Show existing images -->
            <div class="row mb-3">
                @if (ViewBag.AdditionalImages != null)
                {
                    foreach (var img in ViewBag.AdditionalImages)
                    {
                        <div class="col-md-3 text-center mb-3" id="image-@img.Id">
                            <img src="data:image/png;base64,@Convert.ToBase64String(img.Image)"
                                 class="img-fluid rounded shadow mb-2" />
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteImage(@img.Id)">Delete</button>
                        </div>
                    }
                }
            </div>

            <!-- Upload new images -->
            <div id="images-container">
                <div class="input-group mb-2">
                    <input type="file" name="AdditionalImages" class="form-control" accept="image/*" />
                    <button type="button" class="btn btn-danger" onclick="removeImage(this)">X</button>
                </div>
            </div>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="addImage()">+ Add More Images</button>
        </div>


        <!-- URLs -->
        <div class="mb-3">
            <label asp-for="LiveDemoUrl" class="form-label">Live Demo URL</label>
            <input asp-for="LiveDemoUrl" class="form-control" />
        </div>

        <div class="mb-3">
            <label asp-for="GitHubUrl" class="form-label">GitHub URL</label>
            <input asp-for="GitHubUrl" class="form-control" />
        </div>

        <!-- Submit -->
        <div class="text-center">
            <button type="submit" class="btn btn-primary px-4">Save Changes</button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // ===== TOOL HANDLING =====
        function addTool() {
            const container = document.getElementById('tools-container');
            const index = container.querySelectorAll('input[name^="Tools"]').length;

            const div = document.createElement('div');
            div.classList.add('input-group', 'mb-2');
            div.innerHTML = `
                <input type="text" name="Tools[${index}]" class="form-control" placeholder="Enter a tool name" />
                <button type="button" class="btn btn-danger" onclick="removeTool(this)">X</button>
            `;
            container.appendChild(div);
        }

        function removeTool(button) {
            button.parentElement.remove();
        }

        // ===== IMAGE HANDLING =====
        async function deleteImage(id) {
            if (!confirm("Are you sure you want to delete this image?")) return;

            try {
                const response = await fetch(`/Admin/Projects/DeleteProjectImage/${id}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById(`image-${id}`).remove();
                    alert("Image deleted successfully!");
                } else {
                    alert("Failed to delete image.");
                }
            } catch (error) {
                console.error("Error deleting image:", error);
                alert("An error occurred while deleting the image.");
            }
        }

        function addImage() {
            const container = document.getElementById('images-container');
            const div = document.createElement('div');
            div.classList.add('input-group', 'mb-2');
            div.innerHTML = `
                <input type="file" name="AdditionalImages" class="form-control" accept="image/*" />
                <button type="button" class="btn btn-danger" onclick="removeImage(this)">X</button>
            `;
            container.appendChild(div);
        }

        function removeImage(button) {
            button.parentElement.remove();
        }
    </script>
}


}
