@using Microsoft.AspNetCore.Identity
@model IEnumerable<IdentityUser>

@{
    Layout = "_AuthLayout";
    ViewData["Title"] = "Manage Users";
}

<style>
    * {
        color: white !important;
    }
    .table th, .table td {
        vertical-align: middle;
    }
</style>

<div class="container mt-5">
    <h2 class="mb-4 text-center">User Management</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success text-center">@TempData["Success"]</div>
    }

    <table class="table table-bordered table-hover text-center">
        <thead class="table-dark">
            <tr>
                <th>User Name</th>
                <th>Email</th>
                <th>Role</th> <!--  العمود الجديد -->
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        @{
            // Skip first user (default admin)
            var users = Model.Skip(1).ToList();

            // نحتاج الوصول إلى UserManager لجلب الأدوار
            var userManager = Context.RequestServices.GetService<UserManager<IdentityUser>>();
        }

        @foreach (var user in users)
        {
            var roles = await userManager.GetRolesAsync(user);
            var roleName = roles.Any() ? string.Join(", ", roles) : " Not Admin";

            <tr>
                <td>@user.UserName</td>
                <td>@user.Email</td>
                <td>@roleName</td> <!-- ✅ عرض الدور -->
                <td>
                    <!-- Promote to Admin -->
                    <form asp-action="PromoteToAdmin" asp-controller="Admin" method="post" class="d-inline">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <button type="submit" class="btn btn-success btn-sm">Promote to Admin</button>
                    </form>

                    <!-- Disable Admin -->
                    <form asp-action="DisableAdmin" asp-controller="Admin" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to disable this admin?');">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <button type="submit" class="btn btn-warning btn-sm">Disable Admin</button>
                    </form>

                    <!-- Delete User -->
                    <form asp-action="DeleteUser" asp-controller="Admin" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this user?');">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>

    <!-- ✅ زر الرجوع في الأسفل -->
    <div class="text-center mt-4">
        <a asp-area="Admin"
           asp-controller="Dashboard_Admin"
           asp-action="Settings"
           class="btn btn-outline-secondary w-25">
           ← Back
        </a>
    </div>
</div>
